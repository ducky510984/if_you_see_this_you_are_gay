import discord
from discord.ext import commands
import asyncio
import json
import time
from datetime import datetime


def run_bot():
    realtime = datetime.now()
    current_time = realtime.strftime("%H:%M:%S")

    try:
        print("Bot Starting:", current_time)
        intents = discord.Intents.default()
        pingr = commands.Bot(command_prefix="_", help_command=None, intents=intents)

        # Load config data
        with open("config.json") as f:
            geb = json.load(f)
            guildid = int(geb["spam_guild_id"])
            roleid = geb["ping_role_id"]
            bottoken = geb["bot_token"]

        async def ping_task():
            while True:
                guild = pingr.get_guild(guildid)
                for channel in guild.text_channels:
                    if isinstance(channel, discord.TextChannel):
                        if channel.name.startswith('ping'):
                            await channel.send(f"<@&{roleid}>")
                            await asyncio.sleep(0.1)
                        else:
                            pass

        @pingr.event
        async def on_ready():
            pingr.loop.create_task(ping_task())

        pingr.run(bottoken)
    except Exception as exc:
        print("Bot encountered an error. Time: " + current_time + "Error:", exc)
        print("Restarting...")
        time.sleep(5)
        run_bot()

    
if __name__ == "__main__":
    run_bot()
